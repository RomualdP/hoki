---
name: Server Actions Generator
description: G√©n√®re des Next.js Server Actions comme couche d'orchestration mince entre frontend et backend NestJS. √Ä utiliser lors de la cr√©ation d'actions, mutations, ou quand l'utilisateur mentionne "server action", "mutation", "form action", "useTransition", "revalidatePath".
allowed-tools: [Read, Write, Edit, Glob, Grep]
---

# Server Actions Generator

## üéØ Mission

Cr√©er des **Server Actions Next.js** comme **couche d'orchestration mince** entre le frontend et le backend NestJS, avec gestion du cache et des erreurs.

## üèóÔ∏è Philosophie Server Actions

### Qu'est-ce qu'une Server Action ?

Une **Server Action** est une fonction serveur Next.js (`'use server'`) qui :
- ‚úÖ Ex√©cute c√¥t√© serveur (Next.js server, pas client)
- ‚úÖ Peut √™tre appel√©e directement depuis un composant client
- ‚úÖ Simplifie les mutations (pas besoin d'API route)
- ‚úÖ Int√®gre avec les forms HTML natifs

### Architecture Flow

```
Component (Client)
  ‚Üì useTransition() ou form action
Server Action (Next.js Server) [THIN LAYER]
  ‚Üì Validation Zod
  ‚Üì fetch/axios
Backend NestJS API
  ‚Üì Command Handler (CQRS)
  ‚Üì Domain Entity
  ‚Üì Repository
Database (Prisma)
```

### Responsabilit√©s d'une Server Action

**‚úÖ CE QU'ELLE FAIT** :
1. Valider les inputs (Zod)
2. Appeler l'API backend NestJS
3. G√©rer le cache Next.js (`revalidatePath`, `revalidateTag`)
4. Formatter les erreurs pour l'UI
5. Retourner un r√©sultat typ√©

**‚ùå CE QU'ELLE NE FAIT PAS** :
- ‚ùå **JAMAIS** de logique m√©tier (dans le backend)
- ‚ùå **JAMAIS** d'acc√®s direct √† la DB (utiliser backend)
- ‚ùå **JAMAIS** dupliquer la validation backend

## üìù Template Server Action

### Structure de Fichier

```
features/
‚îî‚îÄ‚îÄ club-management/
    ‚îî‚îÄ‚îÄ actions/
        ‚îú‚îÄ‚îÄ create-club.action.ts
        ‚îú‚îÄ‚îÄ update-club.action.ts
        ‚îú‚îÄ‚îÄ delete-club.action.ts
        ‚îú‚îÄ‚îÄ subscribe-to-plan.action.ts
        ‚îî‚îÄ‚îÄ index.ts                  # Barrel export
```

### Template Complet

```typescript
// features/club-management/actions/create-club.action.ts
'use server';

import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { clubsApi } from '../api/clubs.api';

// 1. Schema de validation (synchronis√© avec backend DTO)
const createClubSchema = z.object({
  name: z
    .string()
    .min(3, 'Le nom doit contenir au moins 3 caract√®res')
    .max(100, 'Le nom ne peut pas d√©passer 100 caract√®res'),
  description: z
    .string()
    .max(500, 'La description ne peut pas d√©passer 500 caract√®res')
    .optional(),
});

// 2. Type d'input (inf√©r√© depuis schema)
export type CreateClubInput = z.infer<typeof createClubSchema>;

// 3. Type de r√©sultat
export type CreateClubResult =
  | { success: true; data: { id: string } }
  | { success: false; error: { code: string; message: string; details?: any } };

// 4. Server Action
export async function createClubAction(input: CreateClubInput): Promise<CreateClubResult> {
  try {
    // Validate input
    const validated = createClubSchema.parse(input);

    // Call backend API
    const response = await clubsApi.create(validated);

    // Revalidate cache
    revalidatePath('/dashboard/coach');
    revalidatePath('/clubs');

    // Return success
    return {
      success: true,
      data: response,
    };
  } catch (error) {
    // Handle validation errors
    if (error instanceof z.ZodError) {
      return {
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: 'Les donn√©es fournies sont invalides',
          details: error.errors,
        },
      };
    }

    // Handle API errors
    if (error instanceof ApiError) {
      return {
        success: false,
        error: {
          code: error.code,
          message: error.getUserMessage(),
        },
      };
    }

    // Handle unknown errors
    return {
      success: false,
      error: {
        code: 'UNKNOWN_ERROR',
        message: 'Une erreur est survenue. Veuillez r√©essayer.',
      },
    };
  }
}
```

## üîÑ Cache Management

### revalidatePath

Invalide le cache pour un chemin sp√©cifique.

```typescript
'use server';

export async function createClubAction(input: CreateClubInput) {
  const response = await clubsApi.create(input);

  // Revalidate specific paths
  revalidatePath('/dashboard/coach'); // Coach dashboard
  revalidatePath('/clubs'); // Clubs list page
  revalidatePath(`/clubs/${response.id}`); // Club detail page

  return { success: true, data: response };
}
```

**Quand utiliser** :
- ‚úÖ Apr√®s cr√©ation/modification/suppression de donn√©es
- ‚úÖ Pour forcer le re-fetch des Server Components
- ‚úÖ Pour mettre √† jour l'UI apr√®s mutation

### revalidateTag

Invalide le cache par tag (plus flexible).

```typescript
'use server';

export async function createClubAction(input: CreateClubInput) {
  const response = await clubsApi.create(input);

  // Revalidate by tags
  revalidateTag('clubs'); // All clubs-related data
  revalidateTag(`club-${response.id}`); // Specific club

  return { success: true, data: response };
}

// Dans Server Component ou API route
fetch('/api/clubs', {
  next: { tags: ['clubs'] }
});

fetch(`/api/clubs/${id}`, {
  next: { tags: [`club-${id}`, 'clubs'] }
});
```

**Quand utiliser** :
- ‚úÖ Gestion fine du cache
- ‚úÖ Invalidation group√©e (ex: tous les "clubs")
- ‚úÖ Avec `fetch` et Next.js cache

## üé® Int√©gration avec Composants

### Avec useTransition (Recommended)

```typescript
// components/ClubCreationForm.tsx
'use client';

import { useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { createClubAction, CreateClubInput } from '../actions/create-club.action';
import { toast } from 'sonner';

export function ClubCreationForm() {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (formData: FormData) => {
    setError(null);

    const input: CreateClubInput = {
      name: formData.get('name') as string,
      description: formData.get('description') as string,
    };

    startTransition(async () => {
      const result = await createClubAction(input);

      if (result.success) {
        toast.success('Club cr√©√© avec succ√®s !');
        router.push(`/clubs/${result.data.id}`);
      } else {
        setError(result.error.message);
        toast.error(result.error.message);
      }
    });
  };

  return (
    <form action={handleSubmit} className="space-y-4">
      <input name="name" placeholder="Nom du club" required />
      <textarea name="description" placeholder="Description" />

      {error && (
        <div className="text-red-500 text-sm">{error}</div>
      )}

      <button
        type="submit"
        disabled={isPending}
        className="btn btn-primary"
      >
        {isPending ? 'Cr√©ation...' : 'Cr√©er le club'}
      </button>
    </form>
  );
}
```

### Avec Form Action (HTML Native)

```typescript
// components/QuickClubForm.tsx
'use client';

import { useFormStatus } from 'react-dom';
import { createClubAction } from '../actions/create-club.action';

export function QuickClubForm() {
  return (
    <form action={createClubAction}>
      <input name="name" placeholder="Nom du club" required />
      <SubmitButton />
    </form>
  );
}

function SubmitButton() {
  const { pending } = useFormStatus();

  return (
    <button type="submit" disabled={pending}>
      {pending ? 'Cr√©ation...' : 'Cr√©er'}
    </button>
  );
}
```

### Avec useActionState (React 19)

```typescript
'use client';

import { useActionState } from 'react';
import { createClubAction } from '../actions/create-club.action';

export function ClubForm() {
  const [state, formAction, isPending] = useActionState(
    createClubAction,
    { success: false, error: null }
  );

  return (
    <form action={formAction}>
      <input name="name" />

      {state.error && (
        <div className="error">{state.error.message}</div>
      )}

      <button disabled={isPending}>
        {isPending ? 'Envoi...' : 'Envoyer'}
      </button>
    </form>
  );
}
```

## üö® Error Handling

### Types d'Erreurs

```typescript
// lib/errors.ts

export class ApiError extends Error {
  constructor(
    public code: string,
    message: string,
    public status?: number,
  ) {
    super(message);
    this.name = 'ApiError';
  }

  getUserMessage(): string {
    const messages: Record<string, string> = {
      VALIDATION_ERROR: 'Les donn√©es fournies sont invalides',
      NOT_FOUND: 'La ressource demand√©e n\'existe pas',
      UNAUTHORIZED: 'Vous devez √™tre connect√©',
      FORBIDDEN: 'Vous n\'avez pas les permissions n√©cessaires',
      INTERNAL_SERVER_ERROR: 'Une erreur interne est survenue',
    };

    return messages[this.code] || this.message;
  }
}
```

### Gestion dans Server Action

```typescript
'use server';

export async function updateClubAction(id: string, input: UpdateClubInput) {
  try {
    const validated = updateClubSchema.parse(input);
    const response = await clubsApi.update(id, validated);

    revalidatePath(`/clubs/${id}`);

    return { success: true, data: response };
  } catch (error) {
    // Zod validation errors
    if (error instanceof z.ZodError) {
      return {
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: 'Donn√©es invalides',
          details: error.errors.map(e => ({
            field: e.path.join('.'),
            message: e.message,
          })),
        },
      };
    }

    // API errors (404, 403, etc.)
    if (error instanceof ApiError) {
      return {
        success: false,
        error: {
          code: error.code,
          message: error.getUserMessage(),
        },
      };
    }

    // Network errors
    if (error instanceof TypeError && error.message.includes('fetch')) {
      return {
        success: false,
        error: {
          code: 'NETWORK_ERROR',
          message: 'Impossible de contacter le serveur',
        },
      };
    }

    // Unknown errors
    console.error('Server Action Error:', error);
    return {
      success: false,
      error: {
        code: 'UNKNOWN_ERROR',
        message: 'Une erreur est survenue',
      },
    };
  }
}
```

## üìã Exemples Complets

### Create (POST)

```typescript
'use server';

export async function createClubAction(input: CreateClubInput) {
  const validated = createClubSchema.parse(input);
  const response = await clubsApi.create(validated);

  revalidatePath('/dashboard/coach');

  return { success: true, data: response };
}
```

### Update (PUT/PATCH)

```typescript
'use server';

export async function updateClubAction(id: string, input: UpdateClubInput) {
  const validated = updateClubSchema.parse(input);
  const response = await clubsApi.update(id, validated);

  revalidatePath(`/clubs/${id}`);
  revalidatePath('/dashboard/coach');

  return { success: true, data: response };
}
```

### Delete (DELETE)

```typescript
'use server';

export async function deleteClubAction(id: string) {
  await clubsApi.delete(id);

  revalidatePath('/dashboard/coach');
  revalidatePath('/clubs');

  return { success: true };
}
```

### Batch Operation

```typescript
'use server';

export async function removeMembersAction(clubId: string, memberIds: string[]) {
  const results = await Promise.allSettled(
    memberIds.map(id => clubsApi.removeMember(clubId, id))
  );

  const successful = results.filter(r => r.status === 'fulfilled').length;
  const failed = results.filter(r => r.status === 'rejected').length;

  revalidatePath(`/clubs/${clubId}/members`);

  return {
    success: failed === 0,
    data: { successful, failed },
  };
}
```

## ‚úÖ Checklist Server Actions

- [ ] `'use server'` directive en premi√®re ligne
- [ ] Schema Zod pour validation
- [ ] Types inf√©r√©s depuis schema (`z.infer<>`)
- [ ] Type de r√©sultat (success/error pattern)
- [ ] Appel API backend (pas de logique m√©tier)
- [ ] `revalidatePath()` ou `revalidateTag()` apr√®s mutation
- [ ] Error handling exhaustif (Zod, API, Network, Unknown)
- [ ] Messages d'erreur traduits pour utilisateur
- [ ] Fichier nomm√© `*.action.ts`
- [ ] Export dans barrel `index.ts`

## üö® Erreurs Courantes

### 1. Logique M√©tier dans Server Action

```typescript
// ‚ùå MAUVAIS - Logique m√©tier dans Server Action
export async function createClubAction(input: CreateClubInput) {
  // Validation m√©tier (devrait √™tre dans backend)
  if (input.name.includes('bad_word')) {
    return { success: false, error: 'Name invalid' };
  }

  // Calculs m√©tier (devrait √™tre dans backend)
  const price = input.plan === 'PRO' ? 9.99 : 0;

  // ...
}

// ‚úÖ BON - D√©l√©gation au backend
export async function createClubAction(input: CreateClubInput) {
  // Validation simple
  const validated = createClubSchema.parse(input);

  // Backend fait toute la logique
  const response = await clubsApi.create(validated);

  revalidatePath('/clubs');
  return { success: true, data: response };
}
```

### 2. Oublier revalidatePath

```typescript
// ‚ùå MAUVAIS - Cache pas invalid√©
export async function createClubAction(input: CreateClubInput) {
  const response = await clubsApi.create(input);
  return { success: true, data: response };
  // UI ne se met pas √† jour !
}

// ‚úÖ BON - Cache invalid√©
export async function createClubAction(input: CreateClubInput) {
  const response = await clubsApi.create(input);

  revalidatePath('/clubs'); // Important !

  return { success: true, data: response };
}
```

### 3. Erreurs Non G√©r√©es

```typescript
// ‚ùå MAUVAIS - Erreurs non g√©r√©es
export async function createClubAction(input: CreateClubInput) {
  const response = await clubsApi.create(input); // Peut throw
  return { success: true, data: response };
}

// ‚úÖ BON - Toutes les erreurs g√©r√©es
export async function createClubAction(input: CreateClubInput) {
  try {
    const response = await clubsApi.create(input);
    return { success: true, data: response };
  } catch (error) {
    // Gestion compl√®te des erreurs
    return {
      success: false,
      error: {
        code: 'ERROR',
        message: 'Une erreur est survenue',
      },
    };
  }
}
```

## üìö Skills Compl√©mentaires

- **api-contracts** : DTOs, Types, Validation frontend/backend
- **use-optimistic** : Optimistic updates avec Server Actions
- **atomic-component** : Composants utilisant Server Actions

---

**Rappel** : Server Actions = **Couche mince** d'orchestration. Toute la logique m√©tier est dans le **backend NestJS**.
