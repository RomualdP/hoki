# Prisma Migration Workflow

This document describes the **correct** workflow for managing database migrations with Prisma.

## ‚ö†Ô∏è Golden Rules

### üö´ NEVER DO THIS

1. **NEVER modify a migration file after it has been applied**
   - Files in `prisma/migrations/*/migration.sql` are **read-only**
   - Modifying an applied migration breaks history and creates drift

2. **NEVER use `prisma db push` in production**
   - `db push` is **for rapid development only**
   - It has no history and can cause data loss

3. **NEVER write manual SQL scripts for migrations**
   - Prisma automatically generates safe SQL
   - Manual scripts bypass the versioning system

4. **NEVER run `prisma migrate reset` in production**
   - This command **deletes all data**
   - Reserved for local development only

### ‚úÖ DO THIS

1. **Always create a migration for each schema change**
2. **Use `migrate deploy` in production**
3. **Commit migrations to Git**
4. **Test migrations locally before deploying**

---

## Standard Workflow

### 1. Local Development

#### Modify the schema
```typescript
// prisma/schema.prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String   // ‚Üê New field added
  createdAt DateTime @default(now())
}
```

#### Create the migration
```bash
npx prisma migrate dev --name add_name_to_user
```

**What happens**:
- ‚úÖ Prisma automatically generates the SQL
- ‚úÖ Migration is applied to your local database
- ‚úÖ Prisma Client is regenerated
- ‚úÖ File `migrations/XXXXXX_add_name_to_user/migration.sql` is created

#### Check the generated migration
```bash
cat prisma/migrations/XXXXXX_add_name_to_user/migration.sql
```

Example SQL generated by Prisma:
```sql
-- AlterTable
ALTER TABLE "users" ADD COLUMN "name" TEXT NOT NULL DEFAULT '';
```

#### Commit the migration
```bash
git add prisma/migrations/XXXXXX_add_name_to_user
git add prisma/schema.prisma
git commit -m "feat: add name field to User model"
```

---

### 2. Production Deployment

#### Via Railway (recommended)
```bash
# Railway automatically detects and runs migrations during build
git push origin main
```

Railway automatically executes:
```bash
npx prisma migrate deploy
```

#### Manually if needed
```bash
railway run npx prisma migrate deploy
```

**What happens**:
- ‚úÖ Prisma applies only **unapplied migrations**
- ‚úÖ No data loss
- ‚úÖ History is tracked in the `_prisma_migrations` table

---

## Common Use Cases

### Add an optional column
```typescript
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  bio      String? // ‚Üê Optional (nullable)
}
```

```bash
npx prisma migrate dev --name add_bio_to_user
```

SQL generated by Prisma:
```sql
ALTER TABLE "users" ADD COLUMN "bio" TEXT;
```

---

### Add a required column with default value
```typescript
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  role     String  @default("USER") // ‚Üê Required with default
}
```

```bash
npx prisma migrate dev --name add_role_to_user
```

SQL generated by Prisma:
```sql
ALTER TABLE "users" ADD COLUMN "role" TEXT NOT NULL DEFAULT 'USER';
```

---

### Add a new table
```typescript
model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
}
```

```bash
npx prisma migrate dev --name create_post_table
```

Prisma automatically generates:
- Table `posts` creation
- Index on `authorId`
- Foreign key to `users`

---

### Rename a column (preserving data)
```typescript
model User {
  id        String @id @default(cuid())
  fullName  String @map("name") // ‚Üê Renamed in code but keeps "name" in DB
}
```

Or to actually rename in DB:
```bash
# 1. Create new column
npx prisma migrate dev --name add_fullname_column

# 2. Manually copy data in generated migration
# Edit migration.sql file:
UPDATE users SET "fullName" = "name";

# 3. Remove old column
npx prisma migrate dev --name remove_old_name_column
```

---

## Rapid Development (Prototyping)

For rapid prototyping **locally only**:

```bash
# Synchronize schema without creating migration
npx prisma db push
```

‚ö†Ô∏è **Warning**:
- No migration history
- Do not use if you already have migrations
- Never use in production
- Useful only at the very beginning of a project

Once prototype is validated, create a real migration:
```bash
npx prisma migrate dev --name initial_schema
```

---

## Conflict Management

### If you have drift (schema ‚â† DB)

```bash
# Check drift
npx prisma migrate status

# Resolution in DEV ONLY
npx prisma migrate reset  # ‚ö†Ô∏è Deletes data!
npx prisma migrate dev
```

### If a migration fails in production

```bash
# Check status
railway run npx prisma migrate status

# Resolve failed migration
railway run npx prisma migrate resolve --applied XXXXXX_migration_name

# Or mark as rolled back to fix it
railway run npx prisma migrate resolve --rolled-back XXXXXX_migration_name
```

---

## Pre-deployment Checks

### Pre-deployment Checklist

- [ ] Migrations tested locally
- [ ] Migrations committed to Git
- [ ] Prisma schema matches migrations
- [ ] Tests passing
- [ ] Production database backup done (if critical change)

### Test migrations locally

```bash
# 1. Reset local database
npx prisma migrate reset --force

# 2. Apply all migrations
npx prisma migrate deploy

# 3. Verify everything works
npm test
```

---

## Migration Rollback

Prisma does not support automatic rollback. To undo a migration:

### Option 1: Create a reverse migration
```bash
# Example: undo column addition
npx prisma migrate dev --name remove_column_name
```

### Option 2: Restore backup (in prod)
```bash
# Restore database from backup
# Then mark migrations as applied
railway run npx prisma migrate resolve --applied XXXXXX_bad_migration
```

---

## Useful Commands

```bash
# Check migration status
npx prisma migrate status

# See diff between schema and DB (without applying)
npx prisma migrate diff --from-schema-datamodel prisma/schema.prisma --to-schema-datasource prisma/schema.prisma

# Format Prisma schema
npx prisma format

# See applied migrations
npx prisma migrate status

# Generate client without migration
npx prisma generate
```

---

## Summary

| Action | Environment | Command |
|--------|-------------|---------|
| Modify schema and create migration | Local | `npx prisma migrate dev --name xxx` |
| Apply migrations | Production | `npx prisma migrate deploy` |
| Rapid prototyping | Local only | `npx prisma db push` |
| Complete reset | Local only | `npx prisma migrate reset` |
| Check status | Everywhere | `npx prisma migrate status` |

---

## Resources

- [Prisma Migrate Documentation](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Prisma Migration Best Practices](https://www.prisma.io/docs/guides/migrate/developing-with-prisma-migrate)
- [Troubleshooting Migrations](https://www.prisma.io/docs/guides/migrate/production-troubleshooting)
